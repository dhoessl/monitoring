# Grafana Monitoring Server

Ansible role to automaticly deploy a grafana/influxdb monitoring.

This role is deploying grafana (and its image render plugin), influxdb and a telegraf client to the monitoring server.
To all other servers it is possible to deploy a telegraf client to monitor cpu, memory and disk usage.

# Get Started
## Installation

To deploy the containers you have to add this role to your playbook into the role folder.

Just Cloning inside your ansible playbook folder:
```
git clone https://github.com/dhoessl/monitoring.git roles/monitoring
```

For example as git submodule:
```
git submodule add https://github.com/dhoessl/monitoring.git roles/monitoring
```

## Configuration
After adding the role there need to be some configurations done.

### Variables
In `defaults/main.yaml` most of the variables are already got some defaults.

Some Variables need to be set before running this role.

It is '''recommended''' to also change the usernames of the grafana and infludb user.

Since there are passwords included, they should be saved in a ansible vault file ([Ansible Vault Documentation](https://docs.ansible.com/ansible/latest/cli/ansible-vault.html#create)).

#### Variables Grafana Host
This variables need to be set to the server which is hosting the grafana server. This passwords should be atleast 16 chars long.


Passwords can be generated by using `pwgen`:
```
pwgen -1 -y 16
```

Example inventory vault file (e.g. inventory/prod/example/monitoring_vault.yaml):
```
---
monitoring_grafana_password:  # Password to the grafana admin user
monitoring_influxdb_password:  # Password to the influxdb user
...
```
#### Variables for Grafana Host and Telegraf clients
This variables are used for the Grafana, Influxdb and Telegraf configuration and should be set either in an 'all' inventory file or in a inventory file for each host.

The Token can be generated by using `pwgen`:
```
pwgen -1 -y 64
```

Example inventory vault file (e.g. inventory/prod/all/monitoring_vault.yaml):
```
---
monitoring_influxdb_token:  # Token for access influxdb
...
```

Example inventory file (e.g. inventory/prod/all/monitoring.yaml):
```
---
monitoring_domain: 'example.com' # The Domain on which you access grafana and influxdb
...
```

### Add Role to playbook

In your playbook this role can be added this way (e.g. playbook.yaml):
```
---
- hosts: 'example'
  roles:
    - role: 'monitoring'
      tags: 'monitoring'
```

## Rollout

Since the Configuration is done the config and the containers can be created.

```
ansible-playbook playbook.yaml -i inventory/prod/inventory-prod.yaml -D --tags 'monitoring'
```

### Tags

With this tags you can just run specific parts of this role.
Eiter exclude them by using `--exclude-tags` or just run some tags by using `--tags`.

| Tag | Description |
|---|---|
|monitoring| Run the all tasks|
|monitoring:init| same as `monitoring`|
|monitoring:filesystem| Run tasks to create folder tree for persistent data |
|monitoring:config| Run tasks to create config files |
|monitoring:config:server| Same as `monitoring:config` but only create telegraf and grafana config|
|monitoring:config:client| Same as `monitoring:config` but only create telegraf config on clients |
|monitoring:docker| Run tasks to create the docker container |
|monitoring:docker:server| Create grafana, influxdb and server telegraf container|
|monitoring:docker:client| Create Client telegraf container|
|monitoring:grafana| Create grafana datasource and dashboards|

# Default vars

## Project vars
|Variable                       | Default           | datatype  | Description|
|---                            |---                |---        |---|
|monitoring_server_enabled      | true              | boolean   | Enable/Disable Grafana/Influxdb/Telegraf Server Rollout |
|monitoring_client_enabled      | true              | boolean   | Enable/Disable Telegraf Client Rollout |
|monitoring_state               | present           | string    | Set the state of the docker container|
|monitoring_proto               | http              | string    | The Protocol used for grafana and influxdb |
|monitoring_docker_host_dir     | /var/lib/grafana  | string    | Path to which persistent data will be written on the host |
|monitoring_domain              |                   | string    | Used to build Grafana Webpage url and for telegraf output plugin |

## Grafana vars
|Variable                           | Default           | datatype  | Description|
|---                                |---                |---        |---|
|monitoring_init_grafana            | true              | boolean   | Enable/Disable grafana datasource and dashboard creation |
|monitoring_grafana_filesystem_user | 109               | string    | User which will be used for grafana container and its persistent files |
|monitoring_grafana_port            | 3000              | string    | Port on which grafana will be available in the web |
|monitoring_grafana_username        | admin             | string    | User to login to Grafana |
|monitoring_grafana_password        |                   | string    | Should be vault encrypted - Password to login to Grafana |

## Influxdb vars
|Variable                       | Default           | datatype  | Description|
|---                            |---                |---        |---|
|monitoring_influxdb_port       | 8086              | string    | Port on which influxdb will be available |
|monitoring_influxdb_username   | admin             | string    | User to login to influxdb (v1) |
|monitoring_influxdb_password   |                   | string    | Should be vault encrypted - Password to login to influxdb (v1)|
|monitoring_influxdb_org        | default           | string    | Organization name for influxdb organization |
|monitoring_influxdb_bucket     | default           | string    | Bucket name for first influxdb bucket |
|monitoring_influxdb_retention  | 2w                | string    | Retention Period for influxdb measurements |

## Telegraf server vars
|Variable                                             | Default   | datatype | Description|
|---                                                  |---        |---       |---|
|monitoring_telegraf_port                             | 8125      | string   | Default [StatsD](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md) Port|
|monitoring_telegraf_nginx_status_enabled             | false     | boolean  | Enable/Disable rollout of [nginx telegraf plugin](https://github.com/influxdata/telegraf/blob/release-1.14/plugins/inputs/nginx/README.md) on server|
|monitoring_telegraf_nginx_proto                      | http      | string   | set protocol for nginx telegraf plugin |
|monitoring_telegraf_nginx_base_url                   | localhost | string   | set base_url for nginx telegraf plugin |
|monitoring_telegraf_nginx_port                       | 8090      | string   | set port for nginx telegraf plugin |
|monitoring_telegraf_statsd_enabled                   | false     | boolean  | Enable/Disable rollout of [StatsD](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md) Server for telegraf container on docker host |
|monitoring_telegraf_statsd_proto                     | udp       | string   | StatsD Port |
|monitoring_telegraf_statsd_max_tcp_connections       | 250       | string   | StatsD max_tcp_connection when proto is tcp|
|monitoring_telegraf_statsd_tcp_keep_alive            | false     | string   | StatsD tcp_keep_alive when proto is tcp|
|monitoring_telegraf_statsd_tcp_keep_alive_period     |           |          | defaults to system|
|monitoring_telegraf_statsd_service_address           |           |          | same as monitoring_telegraf_port|
|monitoring_telegraf_statsd_delete_gauges             | true      | string   | Reset Gauges every interval|
|monitoring_telegraf_statsd_delete_counters           | true      | string   | Reset Counters every interval|
|monitoring_telegraf_statsd_delete_sets               | true      | string   | Reset Sets every interval|
|monitoring_telegraf_statsd_delete_timings            | true      | string   | Reset timings and histograms every interval|
|monitoring_telegraf_statsd_percentiles               | [ 50.0, 90.0, 99.0, 99.9, 99.95, 100.0 ] | list | Percentiles to calculate for timing an histogram stats|
|monitoring_telegraf_statsd_percentile_limit          | 1000  | int     | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_metric_separator          | '_'   | string  | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_datalog_extensions        | false | string  | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_datalog_distributions     | false | string  | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_allowed_pending_messages  | 10000 | int     | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_read_buffer_size          | 65535 | int     | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_max_ttl                   | 10h   | string  | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|
|monitoring_telegraf_statsd_sanitize_name_method      | ''    | string  | consult [StatsD Documentation](https://github.com/influxdata/telegraf/blob/release-1.23/plugins/inputs/statsd/README.md)|

## Telegraf client vars
|Variable                             | Default | datatype  | Description|
|---                                  |---      |---        |---|
|monitoring_client_cpu_enabled        | false   | boolean   | Enable/Disable stats of cpu usage |
|monitoring_client_cpu_percpu         | true    | boolean   | Gather information for every cpu |
|monitoring_client_cpu_totalcpu       | true    | boolean   | Gather information about the total cpu usage |
|monitoring_client_cpu_cpu_time       | false   | boolean   | Gather information about cpu times |
|monitoring_client_cpu_report_active  | false   | boolean   | Just report active Cpu |
|monitoring_client_disk_enabled       | false   | boolean   | Enable/Disable stats of disk usage |
|monitoring_client_disk_ignore_fs     | [ 'tmpfs', 'devtmpfs', 'devfs', 'iso9660', 'overlay', 'aufs', 'squashfs' ] | list | Ignored filesystems |
|monitoring_client_disk_mount_points  |         | list      | Specific Disk Mount Points (Not used when not set)|
|monitoring_client_mem_enabled        | false   | boolean   | Enable/Disable stats of memory usage |

